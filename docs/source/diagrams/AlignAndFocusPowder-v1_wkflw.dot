digraph AlignAndFocusPowder {
  label="AlignAndFocusPowder Flowchart"
  $global_style

  subgraph params {
    $param_style
    InputWorkspace
    OutputWorkspace
    RemovePromptPulseWidth
    compressTol1 [label="CompressTolerance"]
    compressTol2 [label="CompressTolerance"]
    MaskWorkspace
    MaskBinTable
    CalibrationWorkspace
    GroupingWorkspace
    UnwrapRef
    LowResRef
    params1 [label="Params"]
    params2 [label="Params"]
  }

  subgraph algorithms {
    $algorithm_style
    applyDiffCal      [label="ApplyDiffCal v1"]
    clearDiffCal      [label="ApplyDiffCal v1\nClear parameters"]
    compressEvents    [label="CompressEvents v1"]
    compressEvents2   [label="CompressEvents v1"]
    convertUnits1     [label="ConvertUnits v1\nTime-of-Flight"]
    convertUnits2     [label="ConvertUnits v1\nd-spacing"]
    convertUnits3     [label="ConvertUnits v1\nTime-of-Flight"]
    convertUnits4     [label="ConvertUnits v1\nd-spacing"]
    convertUnits5     [label="ConvertUnits v1\nwavelength"]
    convertUnits6     [label="ConvertUnits v1\nd-spacing"]
    convertUnits7     [label="ConvertUnits v1\nwavelength"]
    cropWorkspaceTof  [label="CropWorkspace v1\ntof range"]
    cropWorkspaceWL   [label="CropWorkspace v1\nwavelength range"]
    diffFocus         [label="DiffractionFocussing v2"]
    editGeom          [label="EditInstrumentGeometry v1"]
    lorentz           [label="LorentzCorrection v1"]
    maskBins          [label="MaskBins v1\nabsorption resonances"]
    maskBinsTable     [label="MaskBinsFromTable v1"]
    maskDetectors     [label="MaskDetectors v1"]
    rebin1            [label="Rebin or ResampleX"]
    rebin2            [label="Rebin v1"]
    rebin3            [label="Rebin, ResampleX, or\nRebinRagged"]
    rebinRagged       [label="RebinRagged v1"]
    removeLowResTOF   [label="RemoveLowResTOF v1"]
    removePromptPulse [label="RemovePromptPulse v1"]
    unwrapSNS         [label="UnwrapSNS v1"]
  }

  subgraph decisions {
    $decision_style
    isLarge           [label="Is large event workspace?"]
    hasCalibration    [label="Has calibration?"]
    hasResonance      [label="Has absorption\nResonances?"]

    isDspace1         [label="Is d-space binning?"]
    isDspace2         [label="Is d-space binning?"]
    isDspace3         [label="Is d-space binning?"]
    ifParams          [label="LRef specified?"]
    ifParams2          [label="DIFCref specified?"]
    ifRaggedTof       [label="ragged rebin\nand tof binning"]
  }


  InputWorkspace         -> maskDetectors
  MaskWorkspace          -> maskDetectors
  maskDetectors          -> cropWorkspaceTof

  RemovePromptPulseWidth -> removePromptPulse
  cropWorkspaceTof       -> removePromptPulse

  removePromptPulse      -> maskBinsTable
  MaskBinTable           -> maskBinsTable

  maskBinsTable          ->  isLarge
  compressTol1           -> compressEvents
  isLarge                -> compressEvents      [label="Yes"]
  isLarge                -> isDspace1           [label="No"]
  compressEvents         -> isDspace1

  isDspace1              -> rebin1            [label="No"]
  params1                -> rebin1
  rebin1                 -> hasCalibration
  isDspace1              -> hasCalibration    [label="Yes"]

  hasCalibration         -> applyDiffCal         [label="Yes"]
  CalibrationWorkspace   -> applyDiffCal
  applyDiffCal           -> convertUnits4
  hasCalibration         -> convertUnits4        [label="No"]
  convertUnits4          -> clearDiffCal

  clearDiffCal           -> hasResonance
  hasResonance           -> lorentz              [label="No"]
  hasResonance           -> convertUnits5        [label="Yes"]
  convertUnits5          -> maskBins
  maskBins               -> convertUnits6
  convertUnits6          -> lorentz

  lorentz                -> ifParams

  ifParams               -> convertUnits7            [label="No"]
  cropWorkspaceWL        -> convertUnits2

  convertUnits2          -> isDspace2

  ifParams               -> convertUnits1        [label="Yes"]
  convertUnits1          -> unwrapSNS
  UnwrapRef              -> unwrapSNS
  unwrapSNS              -> convertUnits7
  convertUnits7 -> ifParams2


  ifParams2 -> cropWorkspaceWL  [label="No"]
  ifParams2 -> removeLowResTOF  [label="Yes"]

  LowResRef              -> removeLowResTOF
  removeLowResTOF        -> convertUnits2

  isDspace2              -> diffFocus            [label="No"]
  isDspace2              -> rebin2               [label="Yes"]
  params2                -> rebin2
  rebin2                 -> diffFocus
  GroupingWorkspace      -> diffFocus

  diffFocus              -> isDspace3


  isDspace3              -> rebin3               [label="Yes"]
  rebin3                 -> editGeom
  isDspace3              -> editGeom             [label="No"]

  editGeom               -> convertUnits3

  convertUnits3 -> compressEvents2

  compressTol2           -> compressEvents2
  compressEvents2        -> ifRaggedTof
  ifRaggedTof            -> rebinRagged          [label="Yes"]
  rebinRagged            -> OutputWorkspace
  ifRaggedTof            -> OutputWorkspace      [label="No"]
}
